<?phpif(!function_exists('rate_this')){    // Rating Hook    /*-----------------------------------------------------------------------------------*/    add_action('wp_ajax_nopriv_rate_this', 'rate_this');    add_action('wp_ajax_rate_this', 'rate_this');    function rate_this(){        if(isset($_POST['selected_rating'])){            $ip = $_SERVER['REMOTE_ADDR'];            $post_id = intval($_POST['post_id']);            $selected_rating = intval($_POST['selected_rating']);            $meta_IP = get_post_meta($post_id, "voted_IP");            $voted_IP = $meta_IP[0];            if(!is_array($voted_IP))                $voted_IP = array();            if(!in_array($ip, $voted_IP)){                $rating_count = get_post_meta($post_id, "rating_counter", true);                if(empty($rating_count)) { $rating_count = 0; }                $rating_array_holder = get_post_meta($post_id, "rating_array");                if(!empty($rating_array_holder) && is_array($rating_array_holder[0]))                {                    $rating_array = $rating_array_holder[0];                    $rating_array[] = $selected_rating;                }                else                {                    $rating_array = array($selected_rating);                }                if(update_post_meta($post_id,"rating_array", $rating_array ) )                {                    $voted_IP[] = $ip;                    $rating_count++;                    update_post_meta($post_id,'voted_IP', $voted_IP);                    update_post_meta($post_id,'rating_counter', $rating_count);                    $avgRating = get_avg_rating($post_id);                    update_post_meta($post_id,'rating_average', $avgRating);                    _e('Thank you for rating!', 'FoodRecipe');                }                else                {                    _e('Failed', 'FoodRecipe');                }            }            else            {                _e('Already Voted!', 'FoodRecipe');            }        }        else        {            _e('No Rating Found!', 'FoodRecipe');        }        die;    }}// Already Voted Or Not/*-----------------------------------------------------------------------------------*/if(!function_exists('already_voted')){    function already_voted($post_id)    {        $ip = $_SERVER['REMOTE_ADDR'];        $meta_IP = get_post_meta(intval($post_id), "voted_IP");        if(!empty($meta_IP) && is_array($meta_IP[0]))        {            $voted_IP = $meta_IP[0];            return in_array($ip, $voted_IP);        }        return false;    }}// Get Vote Count/*-----------------------------------------------------------------------------------*/if(!function_exists('get_vote_count')){    function get_vote_count($post_id)    {        $meta_IP = get_post_meta(intval($post_id), "voted_IP");        if(!empty($meta_IP) && is_array($meta_IP[0]))        {            $voted_IP = $meta_IP[0];            return count($voted_IP);        }        return 0;    }}// Get Average Rating/*-----------------------------------------------------------------------------------*/if(!function_exists('get_avg_rating')){    function get_avg_rating($post_id)    {        $rating_array_holder = get_post_meta(intval($post_id), "rating_array");        if(!empty($rating_array_holder) && is_array($rating_array_holder[0]))        {            $rating_array = $rating_array_holder[0];            $rating_length = count($rating_array);            $rate_total = array_sum($rating_array);            return round($rate_total/$rating_length,1);        }        return 0;    }}/*-----------------------------------------------------------------------------------*/// Rating Call Functionif(!function_exists('the_recipe_rating')){    function the_recipe_rating($post_id){        $rate_avg = get_avg_rating($post_id);        $rt = 0;        while($rt < 5){            if($rt > $rate_avg-1){$rclass = 'off';} else {$rclass = 'on';}            echo '<span class="'.$rclass.'"></span>';            $rt++;        }    }}?>